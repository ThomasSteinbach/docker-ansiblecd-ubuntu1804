image: docker:latest

stages:
  - lint
  - build
  - test

variables:
  BUILD_IMAGE: "${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME/docker-/}:${CI_COMMIT_REF_NAME}"

before_script:
  - if [ "$CI_COMMIT_REF_NAME" == "master" ]; then IMAGE_TAG="latest"; else IMAGE_TAG="$CI_COMMIT_REF_NAME"; fi
  - IMAGE_NAME="${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME/docker-/}:${IMAGE_TAG}"

.internal_image_name: &int_img_name
  "${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME/docker-/}:${CI_COMMIT_REF_NAME}"

lint:
  stage: lint
  script: docker run --rm -i hadolint/hadolint hadolint
            --ignore DL3008
            --ignore SC2016
            - < Dockerfile

build:
  stage: build
  script: docker build --pull -t "${BUILD_IMAGE}-test" .

test:
  stage: test
  image: "${BUILD_IMAGE}-test"
  script: ansible-playbook test/site.yml

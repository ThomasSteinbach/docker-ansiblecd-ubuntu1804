image: docker:latest

stages:
  - build
  - test

before_script:
  - if [ "$CI_COMMIT_REF_NAME" == "master" ]; then IMAGE_TAG="latest"; else IMAGE_TAG="$CI_COMMIT_REF_NAME"; fi
  - IMAGE_NAME="${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME/docker-/}:${IMAGE_TAG}"

build:
  stage: build
  script: docker build --pull -t "${IMAGE_NAME}" .

test:
  stage: test
  script: docker run --rm "${IMAGE_NAME}" ansible --version
